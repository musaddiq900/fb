<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Page Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .status-card {
            background: linear-gradient(45deg, #4e54c8, #8f94fb);
            color: white;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .data-table {
            background: white;
            border-radius: 10px;
        }
        .btn-scrape {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-scrape:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,107,107,0.4);
        }
        .btn-stop {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            border: none;
        }
        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="logo">üì± Facebook Page Scraper</h1>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="exportData()">üì• Export Excel</button>
                            <button class="btn btn-outline-danger" onclick="clearData()">üóëÔ∏è Clear Data</button>
                        </div>
                    </div>
                    <p class="text-muted mb-0">Extract contact information from Facebook pages in real-time</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-4">
                <!-- Status Card -->
                <div class="card status-card p-3 mb-3">
                    <h5>üìä Scraping Status</h5>
                    <div id="status-display">
                        <div class="mb-2">
                            <small>Status:</small>
                            <span id="status-text" class="badge bg-success">Ready</span>
                        </div>
                        <div class="mb-2">
                            <small>Progress:</small>
                            <div class="progress mt-1">
                                <div id="progress-bar" class="progress-bar bg-info" style="width: 0%"></div>
                            </div>
                            <small id="progress-text">0/0 (0%)</small>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small>Processed:</small>
                                <div id="processed" class="h5">0</div>
                            </div>
                            <div class="col-6">
                                <small>Successful:</small>
                                <div id="successful" class="h5 text-success">0</div>
                            </div>
                            <div class="col-6">
                                <small>Failed:</small>
                                <div id="failed" class="h5 text-danger">0</div>
                            </div>
                            <div class="col-6">
                                <small>Current URL:</small>
                                <div id="current-url" class="small text-truncate">None</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls Card -->
                <div class="card p-3">
                    <h5>‚öôÔ∏è Scraping Controls</h5>
                    
                    <!-- URL Input -->
                    <div class="mb-3">
                        <label class="form-label">Enter Facebook URLs (one per line):</label>
                        <textarea id="urls-input" class="form-control" rows="5" 
                                  placeholder="https://www.facebook.com/example&#10;https://www.facebook.com/another"></textarea>
                        <small class="text-muted">Enter one URL per line</small>
                    </div>

                    <!-- HTML Upload -->
                    <div class="mb-3">
                        <label class="form-label">Or upload HTML file:</label>
                        <input type="file" id="html-file" class="form-control" accept=".html">
                        <small class="text-muted">Upload saved Facebook HTML to extract links</small>
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-grid gap-2">
                        <button id="scrape-btn" class="btn btn-scrape" onclick="startScraping()">
                            üöÄ Start Scraping
                        </button>
                        <button id="stop-btn" class="btn btn-stop" onclick="stopScraping()" disabled>
                            ‚èπÔ∏è Stop Scraping
                        </button>
                    </div>
                </div>

                <!-- Extracted Links Card -->
                <div class="card p-3 mt-3">
                    <h5>üîó Detected Links</h5>
                    <div id="links-list" class="small" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-muted">Links will appear here after HTML upload</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data Table -->
            <div class="col-md-8">
                <div class="card data-table p-3">
                    <h5>üìã Scraped Data</h5>
                    <div class="table-responsive">
                        <table id="data-table" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Country</th>
                                    <th>Likes</th>
                                    <th>Link</th>
                                </tr>
                            </thead>
                            <tbody id="data-body">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted" id="data-count">0 records loaded</small>
                    </div>
                </div>

                <!-- Statistics Card -->
                <div class="card p-3 mt-3">
                    <h5>üìà Statistics</h5>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h3" id="stats-total">0</div>
                            <small class="text-muted">Total Records</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-success" id="stats-emails">0</div>
                            <small class="text-muted">With Email</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-primary" id="stats-phones">0</div>
                            <small class="text-muted">With Phone</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        const socket = io();
        let table;
        
        // Initialize DataTable
        $(document).ready(function() {
            table = $('#data-table').DataTable({
                pageLength: 10,
                order: [[0, 'desc']]
            });
            loadData();
        });

        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('status_update', function(data) {
            updateStatus(data);
        });

        socket.on('new_data', function(data) {
            addDataRow(data);
            updateStatistics();
        });

        // Update status display
        function updateStatus(status) {
            $('#status-text').text(status.is_running ? 'Running' : 'Stopped');
            $('#status-text').removeClass('bg-success bg-danger')
                           .addClass(status.is_running ? 'bg-danger' : 'bg-success');
            
            $('#progress-bar').css('width', status.progress + '%');
            $('#progress-text').text(`${status.processed}/${status.total} (${status.progress}%)`);
            
            $('#processed').text(status.processed);
            $('#successful').text(status.successful);
            $('#failed').text(status.failed);
            $('#current-url').text(status.current_url || 'None');
            
            // Update buttons
            $('#scrape-btn').prop('disabled', status.is_running);
            $('#stop-btn').prop('disabled', !status.is_running);
        }

        // Start scraping
        function startScraping() {
            const urls = $('#urls-input').val().split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);
            
            fetch('/api/scrape', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({links: urls})
            }).then(response => response.json())
              .then(data => {
                  if (data.error) {
                      alert('Error: ' + data.error);
                  }
              });
        }

        // Stop scraping
        function stopScraping() {
            fetch('/api/stop', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                });
        }

        // Load data from server
        function loadData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    
                    table.clear();
                    data.forEach(item => {
                        table.row.add([
                            item.Name || 'N/A',
                            item.Email || 'N/A',
                            item.Phone || 'N/A',
                            item.Country || 'N/A',
                            item.Likes || 'N/A',
                            `<a href="${item['Page Link']}" target="_blank">View</a>`
                        ]);
                    });
                    table.draw();
                    updateStatistics();
                });
        }

        // Add single data row
        function addDataRow(data) {
            table.row.add([
                data.name || 'N/A',
                data.email || 'N/A',
                data.phone || 'N/A',
                data.country || 'N/A',
                data.likes || 'N/A',
                `<a href="${data.page_link}" target="_blank">View</a>`
            ]).draw(false);
            updateStatistics();
        }

        // Update statistics
        function updateStatistics() {
            const rows = table.rows().data().toArray();
            $('#data-count').text(`${rows.length} records`);
            $('#stats-total').text(rows.length);
            
            const withEmail = rows.filter(row => row[1] !== 'N/A').length;
            const withPhone = rows.filter(row => row[2] !== 'N/A').length;
            
            $('#stats-emails').text(withEmail);
            $('#stats-phones').text(withPhone);
        }

        // Export data
        function exportData() {
            window.open('/api/export', '_blank');
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all data?')) {
                fetch('/api/clear', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        loadData();
                    });
            }
        }

        // Handle HTML file upload
        $('#html-file').on('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/upload_html', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
              .then(data => {
                  if (data.error) {
                      alert('Error: ' + data.error);
                      return;
                  }
                  
                  // Update links display
                  const linksList = $('#links-list');
                  linksList.empty();
                  
                  if (data.links && data.links.length > 0) {
                      data.links.forEach(link => {
                          linksList.append(`<div class="text-truncate" title="${link}">üîó ${link}</div>`);
                      });
                      
                      // Pre-fill URLs input
                      $('#urls-input').val(data.links.join('\n'));
                  } else {
                      linksList.html('<div class="text-muted">No Facebook links found</div>');
                  }
                  
                  alert(`Found ${data.links_found} Facebook links`);
              });
        });
    </script>
</body>
</html>